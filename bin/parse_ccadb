#!/usr/bin/env python3

import requests
from contextlib import closing
import csv
from io import StringIO
from datetime import datetime

DATE_FMT = '%Y %b %d'
REMOTE_CSV = 'https://ccadb-public.secure.force.com/microsoft/IncludedCACertificateReportForMSFTCSV'

if __name__ == '__main__':
    fingerprints = set()
    with closing(requests.get(REMOTE_CSV, stream=True, allow_redirects=True)) as r:
        buff = StringIO(r.text)
        for item in csv.DictReader(buff, delimiter=',', quotechar='"'):
            fingerprint = item.get('SHA-1 Fingerprint')
            if not fingerprint:
                continue
            now = datetime.utcnow()
            not_before = datetime.strptime(item.get('Valid From [GMT]'), DATE_FMT)
            not_after = datetime.strptime(item.get('Valid To [GMT]'), DATE_FMT)
            if now < not_before or now > not_after:
                continue
            fingerprints.add(fingerprint)
    print(list(fingerprints))
