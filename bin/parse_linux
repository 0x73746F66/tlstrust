#!/usr/bin/env python3

import hashlib
from pathlib import Path
from OpenSSL.crypto import FILETYPE_PEM, load_certificate, FILETYPE_ASN1, dump_certificate
from datetime import datetime

STORE_PATH = '.data/linux'
"""
cp /etc/ssl/certs/*.pem .data/
sudo chown 1000:1000 .data
Last Updated: 2021-10-20
"""

if __name__ == '__main__':
    fingerprints = set()
    handle = Path(STORE_PATH)
    if not handle.is_dir():
        print(f"directory {STORE_PATH} doesn't exist")
        exit(1)
    now = datetime.utcnow()
    for path in handle.glob('*.pem'):
        cert = load_certificate(FILETYPE_PEM, path.read_bytes())
        try:
            not_before = cert.to_cryptography().not_valid_before
            not_after = cert.to_cryptography().not_valid_after
        except ValueError:
            continue
        if now < not_before or now > not_after:
            continue
        der = dump_certificate(FILETYPE_ASN1, cert)
        fingerprints.add(hashlib.sha1(der).hexdigest().upper())
    print(list(fingerprints))
