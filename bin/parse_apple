#!/usr/bin/env python3
"""
Generated from: https://support.apple.com/en-gb/HT212773
Using: https://www.convertjson.com/html-table-to-json.htm
Last Updated: 2021-10-20
"""
from os.path import basename
from pathlib import Path
import json
from OpenSSL.crypto import FILETYPE_PEM, X509, dump_certificate
from datetime import datetime

DATE_FMT = '%H:%M:%S %d %b %Y'
LOCAL_JSON = '.data/legacy_apple.json'
PREFIX = 'fingerprint_'

def get_module_fingerprints(file_content :str) -> list[str]:
    fingerprints = set()
    for line in file_content.splitlines():
        if not line.startswith(PREFIX):
            continue
        variable_name, *rest = line.split(' = ')
        fingerprint = variable_name.replace(PREFIX, '')
        fingerprints.add(fingerprint)
    return list(fingerprints)

def save_reference_certificate(fingerprint :str, cert :X509):
    module_path = './src/tlstrust/certificates.py'
    filepath = Path(module_path)
    if not filepath.is_file():
        raise OSError(module_path)
    lookup = get_module_fingerprints(filepath.read_text())
    pem = dump_certificate(FILETYPE_PEM, cert)
    if fingerprint not in lookup:
        with filepath.open("a", encoding='utf8') as f:
            f.write(f'{PREFIX}{fingerprint} = """{pem.decode("utf8")}"""\n')

if __name__ == '__main__':
    issuers = set()
    fingerprints = set()
    handle = Path(LOCAL_JSON)
    if not handle.is_file():
        print(f"file {LOCAL_JSON} doesn't exist")
        exit(1)
    data = json.loads(handle.read_bytes())
    now = datetime.utcnow()
    for item in data:
        fingerprint = item.get('Fingerprint (SHA-256)')
        if not fingerprint:
            continue
        if now > datetime.strptime(item.get('Expires'), DATE_FMT):
            continue
        # save_reference_certificate(fingerprint.replace(' ', ''), cert)
        issuers.add(item.get('Certificate name'))
        fingerprints.add(fingerprint)

    issuers = list(filter(None, issuers))
    store_path = Path('src/tlstrust/stores/apple.py')
    store_path.write_text(f'''"""
Do not modify by hand
Generated by: bin/{basename(__file__)}
"""

__module__ = 'tlstrust.stores.apple'

SHA256_FINGERPRINTS = {json.dumps(list(fingerprints), sort_keys=True, indent=4, ensure_ascii=False)}
COMMON_NAMES = {json.dumps(issuers, sort_keys=True, indent=4, ensure_ascii=False)}
''')
