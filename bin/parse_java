#!/usr/bin/env python3
"""
keytool -list -keystore /etc/ssl/certs/java/cacerts
yes "" | sudo keytool -keystore /etc/ssl/certs/java/cacerts -exportcert -rfc -alias debian:ac_raiz_fnmt-rcm.pem -file .data/java/ac_raiz_fnmt-rcm.pem
Last Updated: 2021-10-20
"""
from os.path import basename
import json
from pathlib import Path
from OpenSSL.crypto import FILETYPE_PEM, load_certificate
from datetime import datetime

STORE_PATH = '.data/java'

if __name__ == '__main__':
    handle = Path(STORE_PATH)
    if not handle.is_dir():
        print(f"directory {STORE_PATH} doesn't exist")
        exit(1)

    now = datetime.utcnow()
    lookup = {}
    untrusted = set()
    for path in handle.glob('*.pem'):
        pem = path.read_bytes()
        cert = load_certificate(FILETYPE_PEM, pem)
        ca_common_name = cert.get_issuer().commonName
        if ca_common_name:
            lookup[ca_common_name] = pem.decode()
        try:
            not_before = cert.to_cryptography().not_valid_before
            not_after = cert.to_cryptography().not_valid_after
        except ValueError:
            untrusted.add(ca_common_name)
        if now < not_before or now > not_after:
            untrusted.add(ca_common_name)

    untrusted = sorted(list(filter(None, untrusted)))
    store_path = Path('src/tlstrust/stores/java.py')
    store_path.write_text(f'''"""
Do not modify by hand
Generated by: bin/{basename(__file__)}
"""

__module__ = 'tlstrust.stores.java'
__version__ = 'openjdk version "15.0.3" 2021-04-20'
__description__ = 'Various servers will use different versions, an updated Debian-based server should include the latest Java JDK distrubted by Debian'

UNTRUSTED = {json.dumps(untrusted, indent=4, ensure_ascii=False)}
PEM_FILES = {json.dumps(lookup, sort_keys=True, indent=4, ensure_ascii=False)}
''')
